<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Phân quyền</title>
	<!-- Tell the browser to be responsive to screen width -->
	<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
	<!-- Bootstrap 3.3.6 -->
	<link rel="stylesheet" href="/admin/bootstrap/css/bootstrap.min.css">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
	<!-- Ionicons -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
	<!-- DataTables -->
	<link rel="stylesheet" href="/admin/plugins/datatables/dataTables.bootstrap.css">
	<!-- Theme style -->
	<link rel="stylesheet" href="/admin/dist/css/AdminLTE.min.css">
	<!-- AdminLTE Skins. Choose a skin from the css/skins
			 folder instead of downloading all of them to reduce the load. -->
	<link rel="stylesheet" href="/admin/dist/css/skins/_all-skins.min.css">

	<style type="text/css">
		@import "/stylesheets/global.css";
	</style>

	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
</head>
<body class="hold-transition skin-green sidebar-mini">
<div class="wrapper">

	<header class="main-header">
		<% include ../alte-header %>
	</header>
	<!-- Left side column. contains the logo and sidebar -->
	<aside class="main-sidebar">
		<% include ../alte-left-sidebar %>
	</aside>

	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
		<!-- Content Header (Page header) -->
		<section class="content-header">
			<h1>
				Bảng điều khiển
				
			</h1>
			<ol class="breadcrumb">
				<li><a href="/home"><i class="fa fa-dashboard"></i> Trang chủ</a></li>
				<li><a href="/manager">Quản lý</a></li>
				<li class="active">Quản lý tài khoản</li>
			</ol>
		</section>

		<!-- Main content -->
		<section class="content">
			<!-- /.row -->
			<div class="row">
				<div class="col-xs-12">
					
					<!-- /.box -->

					<div class="box box-primary">
						<div class="box-header">
							<h3 class="box-title" name="quanLyQuyen" >Các quyền trong đề tài</h3>
							<div class="box-tools pull-right">
								<button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
								</button>
								<button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
							</div>
						</div>
						<!-- /.box-header -->
						<div class="box-body">
							<div class="panel-group" id="accordion">
								<div class="panel panel-primary panel-shadow">
									<div class="panel-heading">
										<h4 class="panel-title">
											<a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Thêm loại quyền mới</a>
										</h4>
									</div>
									<div id="collapse1" class="panel-collapse collapse in">
										<div class="panel-body">
											<form action="/config/roles" method="post" id="form-add-role">
												<div class="row">
													<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
														<input type="text" name="rolename" id="rolename" placeholder="Tên" class="form-control" />
													</div>
												</div>
												<div class="row" style="margin-top: 10px">
													<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-top: 10px">
														<label>Quản lý mẫu:</label>
													</div>
													<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6 block" style="padding-left: 0px">
														<select name="side" id="select-new-role" class="form-control">
															<% for(var i in cores.resources) { %>
																<option value="<%= i %>"><%= cores.resources[i].resourceName %></option>
															<% } %>
														</select>
													</div>
												</div>

												<div class="row">
													<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-top: 10px">
														<label>Các quyền:</label>
													</div>
												</div>
												
												<div class="row">
													<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" style="margin-top: 10px">
														<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-left: 0px;">
															<ul class="list-group">
																	<li class="list-group-item">
																		<input name="view" id="cbview" type="checkbox"> 
																		<label for="cbview" style="cursor: pointer">Xem</label>
																	</li>
																
																	<li class="list-group-item">
																		<input name="create" id="cbcreate" type="checkbox"> 
																		<label for="cbcreate" style="cursor: pointer">Thêm</label>
																	</li>
																
															</ul>
														</div>
														<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-left: 0px; padding-right: 0px;">
															<ul class="list-group">
																	<li class="list-group-item">
																		<input name="edit" id="cbedit" type="checkbox"> 
																		<label for="cbedit" style="cursor: pointer">Sửa</label>
																	</li>
																
																	<li class="list-group-item">
																		<input name="delete" id="cbdelete" type="checkbox"> 
																		<label for="cbdelete" style="cursor: pointer">Xóa</label>
																	</li>
																
															</ul>
														</div>
													</div>
												</div>
												<div class="row">
													<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
														<a class="btn btn-primary btn-block" onclick="addRole()">Thêm</a>
													</div>
												</div>
											</form>
										</div>
									</div>
								</div>
								<div class="panel panel-danger panel-shadow-danger">
									<div class="panel-heading">
										<h4 class="panel-title">
											<a data-toggle="collapse" data-parent="#accordion" href="#collapse2">Xóa loại quyền</a>
										</h4>
									</div>
									<div id="collapse2" class="panel-collapse collapse">
										<div class="panel-body">
											<form id="form-delete-role" action="/config/roles/delete" method="post">
												<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-left: 0px;">
														<select id="select-delete-role" name="deleteRole" class="form-control">
															<% for(var j = 0; j < roles.length; j++) {
																if ((roles[j].role != 'admin') && (roles[j].role != 'manager')) { %>
																	<option value="<%= roles[j].role %>"><%= roles[j].rolename %></option>
																<% }
															} %>
														</select>
												</div>
												<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6" style="padding-right: 0px;">
													<a class="btn btn-danger btn-block" style="margin-top: 0px;" onclick="deleteRole()">Xóa</a>
												</div>
											</form>
										</div>
									</div>
								</div>
							</div>
						</div>
						<!-- /.box-body -->
					</div>
					<!-- /.box -->
				</div>
				<!-- /.col -->
			</div>
			<!-- /.row -->
			<div class="row">
				<div class="col-xs-12">
					
					<!-- /.box -->

					<div class="box box-primary">
						<div class="box-header">
							<h3 class="box-title">Tất cả nhân viên trong đề tài</h3>
							<div class="box-tools pull-right">
								<button type="button" class="btn btn-box-tool" id="btnCollapseUsers" data-widget="collapse"><i class="fa fa-minus"></i>
								</button>
								<button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button>
							</div>
						</div>
						<!-- /.box-header -->
						<div class="box-body">
							<table id="example1" class="table table-bordered table-striped">
								<thead>
								<tr>
									<th>Email</th>
									<th>Tên đầy đủ</th>
									<th>Quyền</th>
									<th>Thao tác</th>
								</tr>
								</thead>
								<tbody>
								<%
									function display(obj){
										// console.log(staticPath)
										// console.log(count)
										if (obj instanceof Array){
											var result =  obj.reduce(function (preStr, curElement){
												// console.log(curElement.split('_+_')[1]);
												preStr += '<a href="' + sp + '/' + curElement + '">' + curElement.split('_+_')[1] + '</a><br/>\n';
												return preStr;
											}, '');
											return result;
										}
										else if (obj instanceof Date){
											return [obj.getHours(), obj.getMinutes(), obj.getSeconds()].join(':') + '<br>' + [obj.getDate(), obj.getMonth() + 1, obj.getFullYear()].join(' / ');
										}
										// Need to escape to prevent injected HTML + JS
										return escape(obj);
									}
								%>
								<% for(var i = 0; i < Object.keys(users).length; i++) { 
									var u = users[Object.keys(users)[i]]; %>
										<tr>
											<td><%= u.username %></td>
											<td><%= u.fullname %></td>
											
											
											
											<td>
												<form action="/config" id="<%= u.id %>" method="post" >
													<input type="hidden" value="<%= u.id %>" name="userid" />
													<div class="col-lg-6">
														<ul class="list-group">
															<% for (var j = 0; j < roles.length; j++) { %>
																<% if (j % 2 == 0) { %>
																	<li class="list-group-item">
																		<input <%= (['admin', 'manager'].indexOf(roles[j].role) >= 0) ? 'disabled' : ''%> name="<%= roles[j].role%>" type="checkbox" <%= (u.id in aclRules && aclRules[u.id].indexOf(roles[j].role) > -1) ? 'checked' : '' %> > </input>
																		<span> <a href="/config/roleTooltip?width=500&amp;role=<%= roles[j].role %>&amp;link=#" name="Các quyền" id="jTip-<%= roles[j].role + '-' + u.id %>" class="jTip"><%= roles[j].rolename %></a> </span>
																	</li>
																<% } %>
															<% } %>
														</ul>
													</div>
													<div class="col-lg-6">
														<ul class="list-group">
															<% for (var j = 0; j < roles.length; j++) { %>
																<% if (j % 2 == 1) { %>
																	<li class="list-group-item">
																		<input <%= (['admin', 'manager'].indexOf(roles[j].role) >= 0) ? 'disabled' : ''%> name="<%= roles[j].role%>" type="checkbox" <%= (u.id in aclRules && aclRules[u.id].indexOf(roles[j].role) > -1) ? 'checked' : '' %> > </input>
																		<span> <a href="/config/roleTooltip?width=500&amp;role=<%= roles[j].role %>&amp;link=#" name="Các quyền" id="jTip-<%= roles[j].role + '-' + u.id %>" class="jTip"><%= roles[j].rolename %></a> </span>
																	</li>
																<% } %>
															<% } %>
														</ul>
													</div>
												</form>
											</td>
											<td>
												<button type="button" class="btn btn-primary" onclick="update('<%= u.id %>')" >Update</button>
											</td>
										
										</tr>
									

								<% } %>
								
								</tbody>
								<tfoot>
								<tr>
									<th>Email</th>
									<th>Tên đầy đủ</th>
									
									<th>Quyền</th>
									<th>Thao tác</th>
								</tr>
								</tfoot>
							</table>
						</div>
						<!-- /.box-body -->
					</div>
					<!-- /.box -->
				</div>
				<!-- /.col -->
			</div>
			
		</section>
		<!-- /.content -->
	</div>
	<!-- /.content-wrapper -->
	<footer class="main-footer">
		<div style="height: 400px; width: 100%; ></div>
	</footer>

	<!-- Control Sidebar -->
	
	<!-- /.control-sidebar -->
	<!-- Add the sidebar's background. This div must be placed
			 immediately after the control sidebar -->
	<div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.3 -->
<script src="/admin/plugins/jQuery/jquery-2.2.3.min.js"></script>

<script type="text/javascript">
	// $('.flexdatalist').flexdatalist({
	//       minLength: 0,
	//       valuesSeparator: '_-_'
	//     });
</script>

<!-- Bootstrap 3.3.6 -->
<script src="/admin/bootstrap/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="/admin/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="/admin/plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="/admin/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="/admin/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="/admin/dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script type="text/javascript" src="/javascripts/adminjs.js"></script>
<!-- page script -->
<script src='/javascripts/footer.js'></script>
<script src="/javascripts/jtip.js"></script>

<script>
	$(function () {
		// $("#example2").DataTable();
		$('#example1').DataTable({
			"paging": true,
			"lengthChange": true,
			"searching": true,
			"ordering": true,
			"info": true,
			"autoWidth": false,
			"language": {
				"paginate": {
			        "first":      "Trang đầu",
			        "last":       "Trang cuối",
			        "next":       "Trang sau",
			        "previous":   "Trang trước"
			    },
			    "info": "Đang xem từ _START_ tới _END_ trong tổng số _TOTAL_ bản ghi",
			    "search": "Tìm kiếm:",
			    "lengthMenu":     "Xem _MENU_ dòng",
			    "decimal":        "",
			    "emptyTable":     "Không có dữ liệu",
			    "infoEmpty":      "Đang xem từ 0 tới 0 trong tổng số 0 bản ghi",
			    "infoFiltered":   "(lọc từ tổng số _MAX_ bản ghi)",
			    "infoPostFix":    "",
			    "thousands":      ",",
			    "loadingRecords": "Đang tải...",
			    "processing":     "Đang xử lý...",
			    "zeroRecords":    "Không có bản ghi nào phù hợp",
			    "aria": {
			        "sortAscending":  ": activate to sort column ascending",
			        "sortDescending": ": activate to sort column descending"
			    }
			}
		}).order([0, 'asc']).draw();
	});
</script>

<script>
	function ob (x) {
		return document.getElementById(x);
	}

	function update (id) {
		console.log(id);
		var fd = new FormData(document.getElementById(id));
		console.log(fd);
		console.log(ob(id));
		$.ajax({
			url: '/config',
			method: 'post',
			contentType: false,
			processData: false,
			dataType: 'json',
			data: fd,
			success: function (data) {
				console.log(data);
				if (data.status.localeCompare('success') == 0){
					alert('Cập nhật thành công. Trang sẽ tự reload sau 1s.');
				}
				setTimeout(function () {
					window.location.reload(true);
				}, 1000);
			},
			error: function (err) {
				console.log(err);
				try {
					alert(err.responseJSON.error);
				}
				finally {
					setTimeout(function () {
						window.location.reload(true);
					}, 1000);
				}
			}
		})
	}

	function addRole () {
		var rolename = ob('rolename').value.trim();
		if (rolename.length < 1){
			return alert('Nhập tên');
		}
		var fd = new FormData(document.getElementById('form-add-role'));
		console.log(fd);
		console.log(ob('form-add-role'));
		$.ajax({
			url: '/config/roles',
			method: 'post',
			contentType: false,
			processData: false,
			dataType: 'json',
			data: fd,
			success: function (data) {
				console.log(data);
				if (data.status.localeCompare('success') == 0){
					alert('Cập nhật thành công. Trang sẽ tự reload sau 1s.');
				}
				setTimeout(function () {
					window.location.reload(true);
				}, 1000);
			},
			error: function (err) {
				console.log(err);
				try {
					alert(err.responseJSON.error);
				}
				finally {
					setTimeout(function () {
						window.location.reload(true);
					}, 1000);
				}
			}
		})
	}

	function deleteRole () {

		var select = ob('select-delete-role');
		var selectedOption = select.children[select.selectedIndex];
		// console.log(option);

		if (!confirm('Xóa cấp "' + selectedOption.innerHTML + '", mọi tài khoản được phân vào cấp này sẽ mất quyền thao tác với mẫu dữ liệu do cấp này quản lý.\n\nThao tác này là không thể phục hồi.\n\nXác nhận xóa?')){
			return;
		}
		
		var fd = new FormData(document.getElementById('form-delete-role'));
		$.ajax({
			url: '/config/roles/delete',
			method: 'post',
			contentType: false,
			processData: false,
			dataType: 'json',
			data: fd,
			success: function (data) {
				console.log(data);
				if (data.status.localeCompare('success') == 0){
					alert('Cập nhật thành công. Trang sẽ tự reload sau 1s.');
				}
				setTimeout(function () {
					window.location.reload(true);
				}, 1000);
			},
			error: function (err) {
				console.log(err);
				try {
					alert(err.responseJSON.error);
				}
				finally {
					setTimeout(function () {
						window.location.reload(true);
					}, 1000);
				}
			}
		})
	}
</script>

</body>
</html>
